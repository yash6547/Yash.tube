<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Image to Quiz App</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:900px;margin:20px auto;padding:10px}
    h1{text-align:center}
    #controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;justify-content:center}
    button,input[type=file]{padding:10px;border:none;border-radius:8px;cursor:pointer}
    button{background:#007bff;color:#fff}
    button.gray{background:#6c757d}
    .question{border:1px solid #ddd;padding:10px;margin:10px 0;border-radius:8px}
    .opts label{display:block;margin:5px 0}
    .result{font-weight:bold;font-size:18px;margin-top:15px;text-align:center}
    #video{width:100%;max-width:500px;border-radius:10px;display:none}
  </style>
</head>
<body>
  <h1>ðŸ“¸ Image â†’ MCQ Quiz Generator</h1>

  <div id="controls">
    <input type="file" id="file" accept="image/*">
    <button id="cameraBtn">ðŸ“· Open Camera</button>
    <button id="snapBtn" style="display:none;">ðŸ“¸ Capture</button>
    <button id="detectBtn">Detect Questions</button>
    <button id="attemptBtn" class="gray">Attempt Quiz</button>
  </div>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div id="quiz"></div>
  <div id="result" class="result"></div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script>
  const fileInput = document.getElementById('file');
  const cameraBtn = document.getElementById('cameraBtn');
  const snapBtn = document.getElementById('snapBtn');
  const detectBtn = document.getElementById('detectBtn');
  const attemptBtn = document.getElementById('attemptBtn');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const quizDiv = document.getElementById('quiz');
  const resultDiv = document.getElementById('result');
  let questions = [];
  let stream;

  cameraBtn.onclick = async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      video.style.display = 'block';
      snapBtn.style.display = 'inline-block';
    } catch (err) {
      alert("Camera not accessible!");
    }
  };

  snapBtn.onclick = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    stream.getTracks().forEach(track => track.stop());
    video.style.display = 'none';
    snapBtn.style.display = 'none';
    alert("Photo captured! Now click 'Detect Questions'");
  };

  async function getImageData() {
    if (canvas.width > 0) return canvas; // from camera
    if (!fileInput.files.length) { alert("Select or capture image first!"); return null; }
    const img = new Image();
    const dataUrl = await new Promise(res=>{
      const fr = new FileReader();
      fr.onload = e=>res(e.target.result);
      fr.readAsDataURL(fileInput.files[0]);
    });
    img.src = dataUrl;
    await new Promise(r=>img.onload=r);
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
    return canvas;
  }

  detectBtn.onclick = async () => {
    const imgCanvas = await getImageData();
    if (!imgCanvas) return;
    quizDiv.innerHTML = "Detecting questions...";
    const { data } = await Tesseract.recognize(imgCanvas, 'eng');
    const text = data.text;
    questions = parseQuestions(text);
    showQuiz(false);
  };

  function parseQuestions(text) {
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const qs = []; let curr=null;
    const qPat = /^(\d{1,2})[\.\)]\s*(.+)/;
    const optPat = /^[A-D][\.\)]\s*(.+)/i;
    for (let l of lines) {
      const qm = l.match(qPat);
      if (qm) { if (curr) qs.push(curr); curr={q:qm[2],opts:[]}; continue; }
      const om = l.match(optPat);
      if (om && curr) curr.opts.push(om[0]);
    }
    if (curr) qs.push(curr);
    return qs;
  }

  function showQuiz(attemptMode=false) {
    quizDiv.innerHTML="";
    resultDiv.textContent="";
    questions.forEach((q,i)=>{
      const div=document.createElement('div');
      div.className='question';
      div.innerHTML=`<strong>Q${i+1}.</strong> ${q.q}`;
      const opts=document.createElement('div');opts.className='opts';
      q.opts.forEach((o,j)=>{
        const label=document.createElement('label');
        label.innerHTML=`<input type="radio" name="q${i}" value="${o}"> ${o}`;
        opts.appendChild(label);
      });
      div.appendChild(opts);
      if (!attemptMode) {
        const ansBtn=document.createElement('button');
        ansBtn.textContent='Set Correct Answer';
        ansBtn.onclick=()=>{
          const selected=document.querySelector(`input[name="q${i}"]:checked`);
          if(!selected)return alert("Select option first");
          q.correct=selected.value;
          ansBtn.textContent='âœ… '+q.correct;
        };
        div.appendChild(ansBtn);
      }
      quizDiv.appendChild(div);
    });
    if (attemptMode) {
      const subBtn=document.createElement('button');
      subBtn.textContent='Submit Quiz';
      subBtn.onclick=checkAnswers;
      quizDiv.appendChild(subBtn);
    }
  }

  attemptBtn.onclick = ()=> {
    if (!questions.length) return alert("No quiz loaded!");
    showQuiz(true);
  }

  function checkAnswers(){
    let score=0;
    questions.forEach((q,i)=>{
      const sel=document.querySelector(`input[name="q${i}"]:checked`);
      if(sel && sel.value===q.correct) score++;
    });
    resultDiv.textContent=`âœ… You got ${score} / ${questions.length} correct!`;
  }
  </script>
</body>
</html>
