<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Beast Manual Quiz Builder â€” Final (Result Analysis + Timer + Vibe)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#041025; --card:#071428; --muted:#9fb4c8; --accent:#06b6d4; --accent2:#10b981; --danger:#ef4444; --gold:#ffd54f;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#020617 0%, var(--bg) 100%);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#e6f3fb;-webkit-font-smoothing:antialiased}
.wrap{max-width:1100px;margin:18px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.title{display:flex;flex-direction:column}
.title h1{margin:0;font-size:20px}
.title .sub{color:var(--muted);font-size:13px;margin-top:6px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{background:linear-gradient(180deg,var(--accent) 0%, #05a7bd 100%);color:#021; padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700;box-shadow:0 10px 30px rgba(6,182,212,0.06)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600;padding:8px 12px}
.badge{background:var(--glass);padding:6px 10px;border-radius:999px;font-weight:700;color:var(--muted);font-size:13px}
.panel{background:linear-gradient(180deg,var(--glass) 0%, rgba(255,255,255,0.02) 100%);padding:12px;border-radius:12px;margin-top:12px;border:1px solid rgba(255,255,255,0.03)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.col{display:flex;flex-direction:column;gap:8px}
.small{font-size:13px;color:var(--muted)}
.hidden{display:none!important}
.input, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;font-size:14px}
.textarea{min-height:72px}
.qcard{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));transition:transform .18s ease,box-shadow .18s}
.qcard:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(2,8,23,0.6)}
.opt-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.opt-input{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
.small-ghost{background:transparent;border:1px dashed rgba(255,255,255,0.03);padding:6px;border-radius:6px;color:var(--muted)}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
.counter{font-weight:800;color:var(--muted);font-size:14px}
.controls-bottom{display:flex;gap:8px;align-items:center}
.center{text-align:center}

/* Attempt modal and progress */
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:9999}
.modal-card{width:92%;max-width:900px;background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.progress{height:10px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;transition:width .4s ease}

/* timer styles */
.timer{font-weight:900;color:var(--danger);font-size:18px;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02)}

/* result analysis */
.analysis{display:flex;gap:12px;flex-wrap:wrap}
.analysis-left{flex:1;min-width:280px}
.analysis-right{width:360px;min-width:260px}
.result-card{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.03)}
.score-big{font-size:44px;font-weight:900}
.vibe-msg{font-weight:900;font-size:20px;margin-top:10px}

/* per-question table */
.q-table{width:100%;border-collapse:collapse}
.q-table th, .q-table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;text-align:left}
.q-time{font-size:12px;color:var(--muted)}

/* responsive tweaks */
@media(max-width:820px){
  .analysis-right{width:100%}
  .modal-card{width:96%}
}

/* premium gold theme */
.gold-bg{background:linear-gradient(90deg, rgba(255,215,64,0.08), rgba(255,250,240,0.01));border:1px solid rgba(255,215,64,0.18)}
.gold-text{color:var(--gold);font-weight:900}

/* sad theme */
.sad-text{color:#f3a0a0;font-weight:900}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">
      <h1>âš¡ Beast Manual Quiz Builder â€” Final</h1>
      <div class="sub">Manual quiz â€” add up to 200 Q. One-by-one attempt. Timer, auto-submit, detailed analysis with per-question timing & vibe messages.</div>
    </div>
    <div class="controls">
      <div class="badge">Max Q: <strong id="maxQ">200</strong></div>
      <div class="badge">Total: <strong id="totalQ">0</strong></div>
      <button class="btn" id="btnNew">+ New Q</button>
      <button class="btn ghost" id="btnStart">â–¶ Start Test</button>
      <button class="btn ghost" id="btnSave">ðŸ’¾ Save</button>
      <button class="btn ghost" id="btnLoad">ðŸ“‚ Load</button>
      <button class="btn ghost" id="btnExport">â¬‡ Export</button>
      <button class="btn ghost" id="btnImport">â¬† Import</button>
    </div>
  </div>

  <!-- Editor panel (one-by-one editing) -->
  <div class="panel" id="editorPanel">
    <div class="topbar">
      <div>
        <div style="font-weight:900">Quiz Editor</div>
        <div class="small">Edit questions one-by-one. 2â€“5 options per question. Use per-Q marks or global defaults below.</div>
      </div>
      <div class="controls-bottom">
        <label class="small muted">Global Marks: <input id="gMarks" class="input" type="number" value="1" min="0" step="0.25" style="width:90px"></label>
        <label class="small muted">Global Neg: <input id="gNeg" class="input" type="number" value="0" min="0" step="0.25" style="width:90px"></label>
        <label class="small muted">Time (mins): <input id="gTime" class="input" type="number" value="5" min="0" style="width:90px"></label>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="qcard" id="editorCard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:900">Question <span id="editorIndex">1</span></div>
          <div class="small muted">Type question and options. Use Save to store changes.</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="btnPrev">â—€ Prev</button>
          <button class="btn ghost" id="btnNext">Next â–¶</button>
          <button class="btn ghost" id="btnDuplicate">Duplicate</button>
          <button class="btn ghost" id="btnDelete">Delete</button>
        </div>
      </div>

      <div style="height:8px"></div>
      <textarea id="inpQ" class="textarea input" placeholder="Type the question here..."></textarea>

      <div id="optsArea" style="margin-top:10px"></div>

      <div style="height:8px"></div>
      <div class="row" style="align-items:center">
        <label class="small muted">Per-Q Marks: <input id="inpMarks" type="number" class="input" placeholder="global" style="width:110px"></label>
        <label class="small muted">Per-Q Neg: <input id="inpNeg" type="number" class="input" placeholder="global" style="width:110px"></label>
        <label class="small muted">Flag: <input id="inpFlag" type="checkbox" style="margin-left:8px"></label>
        <div class="right small muted">Opts: <span id="optCount">0</span>/5</div>
      </div>

      <div style="height:8px"></div>
      <div class="row">
        <button class="btn" id="btnAddOpt">+ Add Option</button>
        <button class="btn ghost" id="btnShuffle">Shuffle</button>
        <button class="btn ghost" id="btnSaveQ">Save Question</button>
      </div>
    </div>
  </div>

  <!-- List / quick overview -->
  <div class="panel" id="listPanel">
    <div style="font-weight:900">Quick Overview</div>
    <div class="small muted" style="margin-top:6px">Click an item to edit it in the editor above.</div>
    <div style="height:8px"></div>
    <div id="listArea"></div>
  </div>

  <!-- Analysis area (hidden until results) -->
  <div id="analysisPanel" class="panel hidden">
    <div style="font-weight:900">Result Analysis</div>
    <div style="height:12px"></div>
    <div class="analysis">
      <div class="analysis-left">
        <div class="result-card" id="summaryCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small muted">Total Score</div>
              <div class="score-big" id="finalScore">0</div>
            </div>
            <div style="text-align:right">
              <div class="small muted">Percentage</div>
              <div id="finalPercent" style="font-weight:900;font-size:28px">0%</div>
            </div>
          </div>
          <div class="vibe-msg" id="vibeMsg"></div>
        </div>

        <div style="height:12px"></div>

        <div class="result-card">
          <div style="font-weight:800">Detailed per-question report</div>
          <div style="height:8px"></div>
          <div style="max-height:380px;overflow:auto">
            <table class="q-table" id="qReportTable">
              <thead><tr><th>#</th><th>Q</th><th>Your</th><th>Correct</th><th>Time</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="analysis-right">
        <div class="result-card" id="statsCard">
          <div style="font-weight:800">Summary</div>
          <div style="height:8px"></div>
          <div class="small muted">Total questions: <strong id="statTotal">0</strong></div>
          <div class="small muted">Correct: <strong id="statCorrect">0</strong></div>
          <div class="small muted">Wrong: <strong id="statWrong">0</strong></div>
          <div class="small muted">Unattempted: <strong id="statUn">0</strong></div>
          <div style="height:10px"></div>
          <div class="small muted">Total Time Taken: <strong id="statTime">00:00</strong></div>
          <div style="height:12px"></div>
          <div class="row" style="justify-content:space-between">
            <button class="btn" id="btnBackToEditor">Back to Editor</button>
            <button class="btn ghost" id="btnExportReport">Export Report</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="small muted" style="margin-top:14px">Soch Se Safar | Built by Yash Deshmukh</footer>
</div>

<!-- minimal required JS: app logic -->
<script>
/* =========================
   App State
   ========================= */
const MAX_Q = 200;
let quiz = { title: "Manual Quiz", questions: [] };
let editIndex = 0;
let attemptIndex = 0;
let attemptAnswers = {}; // { idx: {choice:'A', firstTime:ts, lastTime:ts} }
let attemptStartTS = null;
let questionShownTS = null;
let totalSeconds = 0;
let timerInterval = null;

/* =========================
   DOM refs
   ========================= */
const totalQ = document.getElementById('totalQ');
const btnNew = document.getElementById('btnNew');
const btnStart = document.getElementById('btnStart');
const btnSave = document.getElementById('btnSave');
const btnLoad = document.getElementById('btnLoad');
const btnExport = document.getElementById('btnExport');
const btnImport = document.getElementById('btnImport');

const gMarks = document.getElementById('gMarks');
const gNeg = document.getElementById('gNeg');
const gTime = document.getElementById('gTime');

const editorIndex = document.getElementById('editorIndex');
const inpQ = document.getElementById('inpQ');
const optsArea = document.getElementById('optsArea');
const inpMarks = document.getElementById('inpMarks');
const inpNeg = document.getElementById('inpNeg');
const inpFlag = document.getElementById('inpFlag');
const btnPrev = document.getElementById('btnPrev');
const btnNext = document.getElementById('btnNext');
const btnDuplicate = document.getElementById('btnDuplicate');
const btnDelete = document.getElementById('btnDelete');
const btnAddOpt = document.getElementById('btnAddOpt');
const btnShuffle = document.getElementById('btnShuffle');
const btnSaveQ = document.getElementById('btnSaveQ');
const optCount = document.getElementById('optCount');

const listArea = document.getElementById('listArea');

const attemptModal = document.getElementById('attemptModal');
const attemptCard = document.getElementById('attemptCard');
const progBar = document.querySelector('.progress>i');
const timeLeft = document.getElementById('timeLeft') || null;
const btnPrevAttempt = document.getElementById('prevAttempt') || null;
const btnNextAttempt = document.getElementById('nextAttempt') || null;
const btnSubmitAttempt = document.getElementById('submitAttemptBtn');
const btnEndEarly = document.getElementById('endEarly');
const btnMarkReview = document.getElementById('markReview');

const analysisPanel = document.getElementById('analysisPanel');
const finalScoreEl = document.getElementById('finalScore');
const finalPercentEl = document.getElementById('finalPercent');
const vibeMsgEl = document.getElementById('vibeMsg');
const qReportTableBody = document.querySelector('#qReportTable tbody');
const statTotal = document.getElementById('statTotal');
const statCorrect = document.getElementById('statCorrect');
const statWrong = document.getElementById('statWrong');
const statUn = document.getElementById('statUn');
const statTime = document.getElementById('statTime');
const btnBackToEditor = document.getElementById('btnBackToEditor');
const btnExportReport = document.getElementById('btnExportReport');

/* =========================
   Helpers
   ========================= */
function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36).slice(3) + Math.random().toString(36).slice(2,6); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function formatTimeSec(s){ if (!s || s < 0) s=0; const m=Math.floor(s/60), sec = s%60; return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0'); }
function updateCounts(){ totalQ.textContent = quiz.questions.length; }

/* =========================
   Question model helpers
   ========================= */
function createEmptyQuestion(){
  return { id: uid('q'), text:'', options:[ {id:uid('o'),label:'A',text:''},{id:uid('o'),label:'B',text:''} ], correct:null, marks:null, negative:null, flagged:false };
}
function clampOptions(q){
  if (q.options.length < 2) while(q.options.length<2) q.options.push({id:uid('o'),label:String.fromCharCode(65+q.options.length),text:''});
  if (q.options.length > 5) q.options = q.options.slice(0,5);
  q.options.forEach((o,i)=> o.label = String.fromCharCode(65+i));
}

/* =========================
   Rendering editor (single Q)
   ========================= */
function renderEditor(idx=0){
  if (!quiz.questions.length) quiz.questions.push(createEmptyQuestion());
  editIndex = clamp(idx, 0, quiz.questions.length-1);
  const q = quiz.questions[editIndex];
  editorIndex.textContent = editIndex+1;
  inpQ.value = q.text;
  inpMarks.value = q.marks !== null ? q.marks : '';
  inpNeg.value = q.negative !== null ? q.negative : '';
  inpFlag.checked = !!q.flagged;
  renderOptionsUI(q);
  updateCounts();
  renderList();
}

function renderOptionsUI(q){
  clampOptions(q);
  optsArea.innerHTML = '';
  q.options.forEach((opt, i)=>{
    const row = document.createElement('div');
    row.className = 'opt-row';
    row.dataset.optid = opt.id;
    row.innerHTML = `<input type="radio" name="correct" ${q.correct===opt.label ? 'checked' : ''} value="${opt.label}">
      <input class="opt-input" data-optid="${opt.id}" value="${opt.text}" placeholder="Option ${opt.label}">
      <input class="small-ghost" style="width:44px;text-align:center" value="${opt.label}">
      <button class="btn ghost delOpt">Del</button>`;
    optsArea.appendChild(row);

    row.querySelector('input[type=radio]').addEventListener('change', ()=> { q.correct = opt.label; renderList(); });
    row.querySelector('.opt-input').addEventListener('input', (e)=> { opt.text = e.target.value; renderList(); });
    row.querySelector('.small-ghost').addEventListener('input', (e)=> {
      opt.label = e.target.value.toUpperCase().slice(0,2) || opt.label;
      q.options.forEach((oo,ii)=> oo.label = String.fromCharCode(65+ii));
      renderOptionsUI(q);
      renderList();
    });
    row.querySelector('.delOpt').addEventListener('click', ()=>{
      if (q.options.length <= 2) return alert('Minimum 2 options required.');
      q.options = q.options.filter(o=>o.id !== opt.id);
      if (q.correct === opt.label) q.correct = null;
      renderOptionsUI(q);
      renderList();
    });
  });
  optCount.textContent = q.options.length;
}

/* =========================
   Editor Controls
   ========================= */
document.getElementById('btnSaveQ').addEventListener('click', ()=> {
  saveCurrentQuestion();
  alert('Question saved.');
});
function saveCurrentQuestion(){
  const q = quiz.questions[editIndex];
  q.text = inpQ.value.trim();
  q.marks = inpMarks.value === '' ? null : parseFloat(inpMarks.value);
  q.negative = inpNeg.value === '' ? null : parseFloat(inpNeg.value);
  q.flagged = inpFlag.checked;
  // sync options values
  const rows = optsArea.querySelectorAll('.opt-row');
  const newOpts = [];
  rows.forEach((r, i)=>{
    const id = r.dataset.optid || uid('o');
    const label = String.fromCharCode(65 + i);
    const text = r.querySelector('.opt-input').value;
    newOpts.push({ id, label, text });
  });
  q.options = newOpts;
  // if correct invalid now, reset
  if (q.correct && !q.options.some(o=>o.label===q.correct)) q.correct = null;
  clampOptions(q);
  renderList();
}

btnNew.addEventListener('click', ()=>{
  if (quiz.questions.length >= MAX_Q) return alert('Chutiye itne question ka kya karega â€” max ' + MAX_Q);
  quiz.questions.push(createEmptyQuestion());
  renderEditor(quiz.questions.length - 1);
});
document.getElementById('btnPrev').addEventListener('click', ()=> { saveCurrentQuestion(); if (editIndex>0) renderEditor(editIndex-1); });
document.getElementById('btnNext').addEventListener('click', ()=> { saveCurrentQuestion(); if (editIndex < quiz.questions.length-1) renderEditor(editIndex+1); });
document.getElementById('btnDuplicate').addEventListener('click', ()=> {
  if (quiz.questions.length >= MAX_Q) return alert('Max reached');
  saveCurrentQuestion();
  const copy = JSON.parse(JSON.stringify(quiz.questions[editIndex]));
  copy.id = uid('q'); copy.options = copy.options.map(o=>({ id: uid('o'), label: o.label, text: o.text }));
  quiz.questions.splice(editIndex+1, 0, copy);
  renderEditor(editIndex+1);
});
document.getElementById('btnDelete').addEventListener('click', ()=> {
  if (!confirm('Delete this question?')) return;
  quiz.questions.splice(editIndex,1);
  if (!quiz.questions.length) quiz.questions.push(createEmptyQuestion());
  renderEditor(clamp(editIndex,0,quiz.questions.length-1));
});
btnAddOpt.addEventListener('click', ()=> {
  const q = quiz.questions[editIndex];
  if (q.options.length >= 5) return alert('Max 5 options allowed.');
  q.options.push({ id: uid('o'), label: String.fromCharCode(65 + q.options.length), text: '' });
  renderOptionsUI(q);
});
btnShuffle.addEventListener('click', ()=> {
  const q = quiz.questions[editIndex];
  // Fisher-Yates
  for (let i=q.options.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [q.options[i],q.options[j]]=[q.options[j],q.options[i]]; }
  q.options.forEach((o,i)=>o.label=String.fromCharCode(65+i));
  q.correct = null;
  renderOptionsUI(q); renderList();
});

/* Save/load/export/import */
document.getElementById('btnSave').addEventListener('click', ()=> {
  saveCurrentQuestion();
  const payload = { meta:{ savedAt: new Date().toISOString(), gMarks: parseFloat(gMarks.value), gNeg: parseFloat(gNeg.value), gTime: parseInt(gTime.value,10) }, quiz };
  localStorage.setItem('beast_quiz_saved', JSON.stringify(payload));
  alert('Saved locally.');
});
document.getElementById('btnLoad').addEventListener('click', ()=> {
  const raw = localStorage.getItem('beast_quiz_saved');
  if (!raw) return alert('No saved quiz found.');
  try {
    const obj = JSON.parse(raw);
    if (obj.quiz) quiz = obj.quiz;
    if (!quiz.questions || !quiz.questions.length) quiz.questions = [createEmptyQuestion()];
    renderEditor(0);
    alert('Loaded saved quiz.');
  } catch(e){ alert('Load failed'); }
});
document.getElementById('btnExport').addEventListener('click', ()=> {
  saveCurrentQuestion();
  const out = { meta:{ exportedAt: new Date().toISOString(), gMarks:parseFloat(gMarks.value), gNeg:parseFloat(gNeg.value), gTime:parseInt(gTime.value,10) }, quiz };
  const blob = new Blob([JSON.stringify(out, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'manual_quiz_export.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('btnImport').addEventListener('click', ()=> {
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async (e)=> {
    const f = e.target.files[0]; if (!f) return;
    const txt = await f.text();
    try {
      const obj = JSON.parse(txt);
      if (obj.quiz) quiz = obj.quiz; else if (obj.questions) quiz = obj; else quiz = obj;
      if (!quiz.questions || !quiz.questions.length) quiz.questions = [createEmptyQuestion()];
      renderEditor(0);
      alert('Imported quiz.');
    } catch(err){ alert('Import failed'); }
  }; inp.click();
});

/* render quick list */
function renderList(){
  listArea.innerHTML = '';
  quiz.questions.forEach((q,i)=>{
    const card = document.createElement('div'); card.className='qcard';
    const preview = q.text ? (q.text.length>80 ? q.text.slice(0,80)+'...' : q.text) : '<i>[No text]</i>';
    const opts = q.options.map(o=>`${o.label}. ${o.text}`).join(' | ');
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Q${i+1}.</strong> <span class="small muted" style="margin-left:8px">${preview}</span></div>
      <div class="row"><div class="small muted">${q.correct ? 'Ans: '+q.correct : 'No Ans'}</div><button class="btn ghost" data-edit="${i}" style="margin-left:8px">Edit</button></div>
    </div><div class="small muted" style="margin-top:6px">${opts}</div>`;
    listArea.appendChild(card);
  });
  // attach edit
  listArea.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const idx = parseInt(e.currentTarget.getAttribute('data-edit'),10);
      renderEditor(idx);
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });
  updateCounts();
}

/* =========================
   Attempt flow & timing
   ========================= */
btnStart.addEventListener('click', ()=> {
  if (!quiz.questions.length) return alert('Add questions first.');
  saveCurrentQuestion();
  // initialize attempt state
  attemptAnswers = {};
  attemptIndex = 0;
  attemptStartTS = Date.now();
  // total seconds based on gTime (minutes)
  const mins = parseInt(gTime.value,10) || 0; totalSeconds = mins * 60;
  openAttemptModal();
});

function openAttemptModal(){
  // show modal (we reuse modal in DOM but show/hide via class)
  document.getElementById('attemptModal').classList.remove('hidden');
  renderAttemptCard();
  startCountdown();
}

function closeAttemptModal(){
  document.getElementById('attemptModal').classList.add('hidden');
  stopCountdown();
}

/* render attempt card */
function renderAttemptCard(){
  const q = quiz.questions[attemptIndex];
  const inner = document.getElementById('attemptCard');
  inner.innerHTML = '';
  const card = document.createElement('div');
  const marksTxt = q.marks != null ? q.marks : parseFloat(gMarks.value);
  const negTxt = q.negative != null ? q.negative : parseFloat(gNeg.value);
  card.innerHTML = `<div style="font-weight:900;font-size:18px">Q${attemptIndex+1}. ${q.text || '<i>[No text]</i>'}</div>
    <div style="height:10px"></div>
    <div id="attemptOptions"></div>
    <div style="height:10px"></div>
    <div class="small muted">Marks: ${marksTxt} | Negative: ${negTxt}</div>`;
  inner.appendChild(card);
  const optsWrap = document.getElementById('attemptOptions');
  q.options.forEach(opt=>{
    const lab = document.createElement('label');
    lab.className='opt-row';
    lab.innerHTML = `<input type="radio" name="attAns" value="${opt.label}" ${attemptAnswers[attemptIndex] && attemptAnswers[attemptIndex].choice===opt.label ? 'checked' : ''}> <div style="margin-left:8px">${opt.label}. ${opt.text}</div>`;
    optsWrap.appendChild(lab);
  });
  // attach change listener to all radios
  optsWrap.querySelectorAll('input[type=radio]').forEach(r=>{
    r.addEventListener('change', (e)=>{
      const now = Date.now();
      if (!attemptAnswers[attemptIndex]) {
        attemptAnswers[attemptIndex] = { choice: e.target.value, firstTime: now, lastTime: now, times: [now] };
      } else {
        attemptAnswers[attemptIndex].choice = e.target.value;
        attemptAnswers[attemptIndex].lastTime = now;
        attemptAnswers[attemptIndex].times.push(now);
      }
      updateProgressBar();
    });
  });
  // record that question is shown now (for timing if needed)
  questionShownTS = Date.now();
  updateProgressBar();
}

/* next / prev within modal */
document.getElementById('nextAttempt').addEventListener('click', ()=> {
  // optionally save state
  if (attemptIndex < quiz.questions.length - 1) attemptIndex++;
  renderAttemptCard();
});
document.getElementById('prevAttempt').addEventListener('click', ()=> {
  if (attemptIndex > 0) attemptIndex--;
  renderAttemptCard();
});

/* progress update */
function updateProgressBar(){
  const answered = Object.keys(attemptAnswers).length;
  const pct = Math.round((answered / quiz.questions.length) * 100);
  progBar.style.width = pct + '%';
}

/* timer (countdown) */
function startCountdown(){
  if (timerInterval) clearInterval(timerInterval);
  if (totalSeconds <= 0) {
    // no timer
    document.getElementById('timeLeft').textContent = 'No timer';
    return;
  }
  const endTS = Date.now() + totalSeconds * 1000;
  timerInterval = setInterval(()=>{
    const rem = Math.round((endTS - Date.now())/1000);
    document.getElementById('timeLeft').textContent = formatTimeSec(rem);
    if (rem <= 0) {
      clearInterval(timerInterval);
      autoSubmitOnTimeUp();
    }
  }, 500);
}
function stopCountdown(){ if (timerInterval) clearInterval(timerInterval); timerInterval = null; }

/* auto submit when time up */
function autoSubmitOnTimeUp(){
  alert('Time up! Auto-submitting test.');
  finalizeAttempt(true);
}

/* manual submit */
btnSubmitAttempt.addEventListener('click', ()=> {
  if (!confirm('Submit test now?')) return;
  finalizeAttempt(false);
});

/* finalize attempt - compute scores & show analysis */
function finalizeAttempt(isAuto=false){
  stopCountdown();
  // compute per-question times and total time
  const totalTakenSec = Math.round((Date.now() - attemptStartTS)/1000);
  // scoring
  let totalScore = 0, correct = 0, wrong = 0, unattempted = 0;
  const gM = parseFloat(gMarks.value) || 0;
  const gN = parseFloat(gNeg.value) || 0;

  const reportRows = [];

  quiz.questions.forEach((q, idx) => {
    const ansObj = attemptAnswers[idx];
    const userChoice = ansObj ? ansObj.choice : null;
    const timeTaken = ansObj ? Math.round(((ansObj.lastTime || ansObj.firstTime) - (ansObj.firstTime || attemptStartTS))/1000) : null;
    // if user never answered, we could compute time between first shown and leaving; but we'll show '-' for unattempted
    let isCorrect = false;
    if (!userChoice) { unattempted++; }
    else if (q.correct && userChoice === q.correct) {
      isCorrect = true; correct++;
      const m = q.marks != null ? q.marks : gM;
      totalScore += parseFloat(m);
    } else {
      wrong++;
      const neg = q.negative != null ? q.negative : gN;
      totalScore -= parseFloat(neg);
    }
    reportRows.push({ idx: idx+1, qtext: q.text, user: userChoice || '-', correct: q.correct || '-', time: timeTaken });
  });

  // compute percentage: sum of positive marks possible? We'll compute maximum possible as sum of marks for all questions (use per-q or global)
  let maxPossible = 0;
  quiz.questions.forEach(q => { maxPossible += (q.marks != null ? q.marks : gM); });
  const percent = maxPossible > 0 ? Math.round(( (totalScore / maxPossible) * 100 )) : 0;
  const pctClamped = clamp(percent, -999, 100);

  // prepare analysis UI
  showAnalysis({ totalScore, correct, wrong, unattempted, percent: pctClamped, totalTakenSec, reportRows });
  // close modal if open
  document.getElementById('attemptModal').classList.add('hidden');
}

/* show analysis screen */
function showAnalysis({ totalScore, correct, wrong, unattempted, percent, totalTakenSec, reportRows }){
  analysisPanel.classList.remove('hidden');
  // summary panel
  finalScoreEl.textContent = totalScore;
  finalPercentEl.textContent = percent + '%';
  statTotal.textContent = quiz.questions.length;
  statCorrect.textContent = correct;
  statWrong.textContent = wrong;
  statUn.textContent = unattempted;
  statTime.textContent = formatTimeSec(totalTakenSec);

  // vibe message logic and theming
  vibeMsgEl.className = 'vibe-msg';
  if (percent >= 100) {
    vibeMsgEl.innerHTML = 'âš¡ GOD MODE ACTIVATED â€” kuch zindagi mein uchaad hi diya bhai ðŸ‘‘';
    vibeMsgEl.classList.add('gold-text');
    // premium style for summary card
    document.getElementById('summaryCard').classList.add('gold-bg');
  } else if (percent >= 90) {
    vibeMsgEl.innerHTML = 'Bhai confirm hai â€” pakka ho jayega ðŸ’ªðŸ’¯';
    vibeMsgEl.style.color = '#1e90ff';
    document.getElementById('summaryCard').classList.remove('gold-bg');
  } else if (percent >= 50) {
    vibeMsgEl.innerHTML = 'Bhai tera selection ho jayega ðŸ˜ŽðŸ”¥';
    vibeMsgEl.style.color = 'lightgreen';
    document.getElementById('summaryCard').classList.remove('gold-bg');
  } else {
    vibeMsgEl.innerHTML = 'à¤­à¥ˆà¤¯à¤¾ à¤œà¥€ sorry, à¤†à¤ªà¤•à¤¾ à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹ à¤ªà¤¾à¤à¤—à¤¾ â€” bhiya ji, sorry apka ni ho payega';
    vibeMsgEl.classList.add('sad-text');
    document.getElementById('summaryCard').classList.remove('gold-bg');
  }

  // fill per-question table
  qReportTableBody.innerHTML = '';
  reportRows.forEach(r => {
    const tr = document.createElement('tr');
    const timeTxt = r.time === null ? '-' : (r.time + 's');
    // color row based on correctness
    const qObj = quiz.questions[r.idx - 1];
    const isCorrect = r.user !== '-' && qObj.correct && r.user === qObj.correct;
    tr.innerHTML = `<td>${r.idx}</td>
      <td style="max-width:300px">${escapeHtml(r.qtext.length > 120 ? r.qtext.slice(0,120)+'...' : r.qtext)}</td>
      <td>${escapeHtml(r.user)}</td>
      <td>${escapeHtml(r.correct)}</td>
      <td class="q-time">${timeTxt}</td>`;
    if (isCorrect) tr.style.background = 'linear-gradient(90deg, rgba(16,185,129,0.03), transparent)';
    else if (r.user === '-') tr.style.background = 'linear-gradient(90deg, rgba(255,200,60,0.02), transparent)';
    else tr.style.background = 'linear-gradient(90deg, rgba(255,60,60,0.02), transparent)';
    qReportTableBody.appendChild(tr);
  });

  // scroll analysis into view
  analysisPanel.scrollIntoView({ behavior: 'smooth' });
}

/* export analysis as JSON */
btnExportReport.addEventListener('click', ()=>{
  // build report
  saveCurrentQuestion();
  // reconstruct attempt report (we need to include attemptAnswers)
  const attempt = { answers: attemptAnswers, quiz, meta:{ exportedAt: new Date().toISOString() } };
  const blob = new Blob([JSON.stringify(attempt, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'quiz_attempt_report.json'; a.click(); URL.revokeObjectURL(url);
});

/* back to editor from analysis */
btnBackToEditor.addEventListener('click', ()=> {
  analysisPanel.classList.add('hidden');
  // keep everything as it was in editor
  renderEditor(editIndex);
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

/* utility */
function escapeHtml(s){ if (!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* keyboard shortcuts for attempt navigation (when modal open) */
document.addEventListener('keydown', (e)=>{
  const modalVisible = !document.getElementById('attemptModal').classList.contains('hidden');
  if (modalVisible) {
    if (e.key === 'ArrowRight') document.getElementById('nextAttempt').click();
    if (e.key === 'ArrowLeft') document.getElementById('prevAttempt').click();
  } else {
    if (e.key === 'n') btnNew.click();
    if ( (e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='s') { e.preventDefault(); btnSave.click(); }
  }
});

/* =========================
   Init with one sample Q
   ========================= */
(function init(){
  quiz.questions.push({
    id: uid('q'),
    text: 'Sample: Which gas do plants absorb during photosynthesis?',
    options: [ {id:uid('o'),label:'A',text:'Oxygen'}, {id:uid('o'),label:'B',text:'Carbon Dioxide'}, {id:uid('o'),label:'C',text:'Nitrogen'} ],
    correct: 'B', marks: null, negative: null, flagged:false
  });
  renderEditor(0);
  renderList();
})();

</script>
</body>
</html>
