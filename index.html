<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Manual MCQ Creator ‚Äî Upload + Crop + Manual</title>

<!-- CropperJS CSS -->
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>

<style>
  :root{
    --bg:#071428; --card:#0b1720; --accent:#06b6d4; --muted:#9fb4c8; --ok:#10b981; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#041226 0%, #071428 100%);color:#e6f0f6}
  .wrap{max-width:1100px;margin:18px auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;margin-top:12px;border:1px solid rgba(255,255,255,0.03)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:8px}
  button{background:var(--accent);color:#012;border:0;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:8px}
  .icon-btn{background:rgba(255,255,255,0.03);border-radius:10px;padding:8px 10px;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  .hidden{display:none!important}
  .preview-img{max-width:100%;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .crop-area{max-width:820px;margin:10px auto}
  textarea,input[type="text"],input[type="number"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .question-card{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:10px;background:rgba(255,255,255,0.01)}
  .opt-row{display:flex;gap:8px;align-items:center;margin-top:6px}
  .btn-danger{background:var(--danger);color:#fff}
  .muted{color:var(--muted)}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .option-input{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
  .small-ghost{background:transparent;border:1px dashed rgba(255,255,255,0.03);padding:6px;border-radius:6px;color:var(--muted)}
  .badge{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;color:var(--muted);font-weight:700}
  @media(max-width:720px){ .wrap{padding:8px} .row{justify-content:center} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>‚úçÔ∏è Manual MCQ Creator</h1>
      <div class="sub">Upload image ‚Üí Crop & rotate (reference) ‚Üí Type questions manually ‚Üí Attempt & Export</div>
    </div>
    <div class="row">
      <label class="ghost" style="cursor:pointer">
        üìÅ Upload Image
        <input id="fileInput" type="file" accept="image/*" style="display:none">
      </label>
      <button id="clearImage" class="ghost">Clear Image</button>
      <button id="exportJSON" class="ghost">Export JSON</button>
      <button id="importJSON" class="ghost">Import JSON</button>
      <button id="exportPDF" class="ghost">Export PDF</button>
      <button id="saveLocal" class="ghost">Save Locally</button>
      <button id="loadLocal" class="ghost">Load Local</button>
    </div>
  </header>

  <!-- Image preview and crop -->
  <div id="imagePanel" class="panel hidden">
    <div class="flex-between">
      <div style="font-weight:700">Reference Image (Crop area)</div>
      <div class="small muted">Crop area ko adjust karo ‚Äî phir "Apply Crop" kro.</div>
    </div>
    <div style="height:10px"></div>
    <div class="crop-area">
      <img id="cropImage" src="" alt="To crop" style="max-width:100%;display:block" />
    </div>
    <div class="row" style="justify-content:center;margin-top:8px">
      <button id="rotateLeft" class="icon-btn">‚ü≤ Rotate Left</button>
      <button id="rotateRight" class="icon-btn">‚ü≥ Rotate Right</button>
      <button id="flipHorizontal" class="icon-btn">‚Üî Flip</button>
      <button id="applyCrop" class="btn">Apply Crop</button>
      <button id="cancelCrop" class="ghost">Cancel</button>
    </div>
    <div style="height:10px"></div>
    <div id="croppedPreviewWrap" class="hidden">
      <div style="font-weight:700">Cropped Preview</div>
      <img id="croppedPreview" class="preview-img" src="" alt="cropped preview" />
    </div>
  </div>

  <!-- Manual question input -->
  <div id="editorPanel" class="panel">
    <div class="flex-between">
      <div style="font-weight:700">Quiz Editor</div>
      <div class="row">
        <div class="badge small muted">Questions: <span id="qcount">0</span></div>
        <button id="addQuestion" class="ghost">+ Add Question</button>
      </div>
    </div>

    <div style="height:10px"></div>
    <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <div id="questionsWrap"></div>

        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <div class="col" style="max-width:420px">
            <div style="font-weight:700">Scoring (global default)</div>
            <div class="row">
              <label class="small muted">Marks / Q: <input id="marksPerQ" type="number" value="1" min="0" step="0.25"></label>
              <label class="small muted">Negative / wrong: <input id="negPerQ" type="number" value="0" min="0" step="0.25"></label>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button id="attemptMode" class="btn">Attempt Quiz</button>
          <button id="clearQuiz" class="ghost">Clear All</button>
        </div>
      </div>

      <div style="width:320px">
        <div style="font-weight:700">Image Reference</div>
        <div class="small muted">The cropped image below is just a reference ‚Äî type questions manually on left.</div>
        <div style="height:8px"></div>
        <div style="border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)">
          <img id="refImage" class="preview-img" src="" alt="ref" />
          <div style="height:8px"></div>
          <button id="useRefClear" class="ghost">Clear Reference</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Attempt Panel -->
  <div id="attemptPanel" class="panel hidden">
    <div class="flex-between">
      <div style="font-weight:700">Attempt Quiz</div>
      <div class="small muted">Marks per Q: <span id="marksSummary"></span> | Negative: <span id="negSummary"></span></div>
    </div>
    <div style="height:8px"></div>
    <div id="attemptQuestions"></div>

    <div style="height:12px"></div>
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="small muted">Questions: <span id="attemptCount">0</span></div>
      <div class="row">
        <button id="submitAttempt" class="btn">Submit</button>
        <button id="backToEdit" class="ghost">Back to Edit</button>
      </div>
    </div>

    <div style="height:12px"></div>
    <div id="resultBox" class="hidden question-card"></div>
  </div>

  <footer>Manual mode ‚Äî koi automatic detection nahi. Type with dhyaan, test, export. Bol agar kuch aur add karna hai.</footer>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
<!-- html2pdf for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<script>
/* ======= App State ======= */
let cropper = null;
let croppedDataURL = null;
let quiz = { title: "Manual Quiz", questions: [] };

/* ======= Elements ======= */
const fileInput = document.getElementById('fileInput');
const imagePanel = document.getElementById('imagePanel');
const cropImage = document.getElementById('cropImage');
const rotateLeft = document.getElementById('rotateLeft');
const rotateRight = document.getElementById('rotateRight');
const flipHorizontal = document.getElementById('flipHorizontal');
const applyCrop = document.getElementById('applyCrop');
const cancelCrop = document.getElementById('cancelCrop');
const croppedPreviewWrap = document.getElementById('croppedPreviewWrap');
const croppedPreview = document.getElementById('croppedPreview');

const editorPanel = document.getElementById('editorPanel');
const addQuestionBtn = document.getElementById('addQuestion');
const questionsWrap = document.getElementById('questionsWrap');
const qcount = document.getElementById('qcount');
const marksPerQ = document.getElementById('marksPerQ');
const negPerQ = document.getElementById('negPerQ');

const refImage = document.getElementById('refImage');
const useRefClear = document.getElementById('useRefClear');

const attemptModeBtn = document.getElementById('attemptMode');
const attemptPanel = document.getElementById('attemptPanel');
const attemptQuestions = document.getElementById('attemptQuestions');
const marksSummary = document.getElementById('marksSummary');
const negSummary = document.getElementById('negSummary');
const submitAttempt = document.getElementById('submitAttempt');
const backToEdit = document.getElementById('backToEdit');
const attemptCount = document.getElementById('attemptCount');
const resultBox = document.getElementById('resultBox');

const exportJSON = document.getElementById('exportJSON');
const importJSON = document.getElementById('importJSON');
const exportPDF = document.getElementById('exportPDF');
const clearImageBtn = document.getElementById('clearImage');
const saveLocal = document.getElementById('saveLocal');
const loadLocal = document.getElementById('loadLocal');

/* ======= File upload and Cropper ======= */
fileInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    cropImage.src = reader.result;
    imagePanel.classList.remove('hidden');
    // init cropper
    setTimeout(()=> {
      if (cropper) { cropper.destroy(); cropper = null; }
      cropper = new Cropper(cropImage, {
        viewMode: 1,
        autoCropArea: 0.9,
        movable: true,
        zoomable: true,
        rotatable: true,
        responsive: true,
        background: false
      });
    }, 100);
  };
  reader.readAsDataURL(f);
});

// cropper controls
rotateLeft.addEventListener('click', ()=> cropper && cropper.rotate(-90));
rotateRight.addEventListener('click', ()=> cropper && cropper.rotate(90));
flipHorizontal.addEventListener('click', ()=> {
  if (!cropper) return;
  const data = cropper.getImageData();
  cropper.scaleX(- (data.scaleX || 1));
});

cancelCrop.addEventListener('click', ()=>{
  if (cropper) { cropper.destroy(); cropper=null; }
  imagePanel.classList.add('hidden');
  fileInput.value = '';
  croppedDataURL = null;
  croppedPreviewWrap.classList.add('hidden');
  refImage.src = '';
});

// apply crop
applyCrop.addEventListener('click', ()=>{
  if (!cropper) return alert('Crop area ready kar ke Apply karo.');
  const canvas = cropper.getCroppedCanvas({imageSmoothingQuality:'high', maxWidth:2000, maxHeight:2000});
  croppedDataURL = canvas.toDataURL('image/jpeg', 0.95);
  croppedPreview.src = croppedDataURL;
  croppedPreviewWrap.classList.remove('hidden');
  refImage.src = croppedDataURL;
  // destroy cropper UI
  cropper.destroy(); cropper = null;
  imagePanel.classList.add('hidden');
});

/* ======= Quiz Editor: Manual add/edit/delete ======= */
function createEmptyQuestion() {
  return {
    id: 'q'+Date.now()+Math.random().toString(36).slice(2,6),
    text: 'New question ‚Äî edit here',
    options: [
      { id: 'o1', label: 'A', text: 'Option A' },
      { id: 'o2', label: 'B', text: 'Option B' },
      { id: 'o3', label: 'C', text: 'Option C' }
    ],
    correct: null,
    marks: null, // if null -> use global
    negative: null
  };
}

function renderEditor() {
  questionsWrap.innerHTML = '';
  quiz.questions.forEach((q, idx) => {
    const card = document.createElement('div');
    card.className = 'question-card';
    card.dataset.qid = q.id;
    card.innerHTML = `
      <div class="flex-between">
        <div style="font-weight:700">Q${idx+1}</div>
        <div class="row">
          <button class="icon-btn edit-q">Edit</button>
          <button class="icon-btn add-opt">+Opt</button>
          <button class="icon-btn del-q">Del</button>
        </div>
      </div>
      <div style="margin-top:8px">
        <textarea class="qtext">${escapeHtml(q.text)}</textarea>
      </div>
      <div class="opts-area" style="margin-top:8px"></div>
      <div style="margin-top:8px" class="small muted">Correct: <span class="corr">${q.correct || 'Not set'}</span> | Marks: <input class="small marks-input" type="number" value="${q.marks ?? ''}" placeholder="global"></div>
    `;
    questionsWrap.appendChild(card);

    const optsArea = card.querySelector('.opts-area');

    function renderOptions() {
      optsArea.innerHTML = '';
      q.options.forEach((opt, oi) => {
        const row = document.createElement('div');
        row.className = 'opt-row';
        row.innerHTML = `
          <input type="radio" name="corr_${q.id}" ${q.correct===opt.label ? 'checked' : ''} value="${opt.label}">
          <input class="option-input opt-text" data-optid="${opt.id}" value="${escapeHtml(opt.text)}">
          <input style="width:60px" class="small-ghost opt-label" value="${opt.label}">
          <button class="ghost del-opt">Del</button>
        `;
        optsArea.appendChild(row);

        // listeners
        row.querySelector('input[type=radio]').addEventListener('change', ()=>{
          q.correct = opt.label;
          card.querySelector('.corr').textContent = q.correct;
        });
        row.querySelector('.opt-text').addEventListener('input', (e)=> { opt.text = e.target.value; });
        row.querySelector('.opt-label').addEventListener('input', (e)=>{
          opt.label = e.target.value.toUpperCase().slice(0,2) || opt.label;
          renderOptions();
        });
        row.querySelector('.del-opt').addEventListener('click', ()=>{
          if (q.options.length<=2) return alert('Minimum 2 options required');
          q.options = q.options.filter(o=>o.id!==opt.id);
          renderOptions();
        });
      });
    }
    renderOptions();

    // edit q text
    card.querySelector('.qtext').addEventListener('input', (e)=> q.text = e.target.value);
    // add opt
    card.querySelector('.add-opt').addEventListener('click', ()=>{
      const nextLabel = String.fromCharCode(65 + q.options.length);
      q.options.push({ id: 'o'+Math.random().toString(36).slice(2,6), label: nextLabel, text: 'New option' });
      renderOptions();
    });
    // delete q
    card.querySelector('.del-q').addEventListener('click', ()=>{
      if (!confirm('Delete this question?')) return;
      quiz.questions = quiz.questions.filter(x=>x.id !== q.id);
      renderEditor();
    });
    // edit q quick
    card.querySelector('.edit-q').addEventListener('click', ()=>{
      const newq = prompt('Edit question text', q.text);
      if (newq!=null) { q.text = newq; card.querySelector('.qtext').value = q.text; }
    });
    // marks input
    card.querySelector('.marks-input').addEventListener('input', (e)=> {
      const v = e.target.value;
      q.marks = v === '' ? null : parseFloat(v);
    });
  });

  qcount.textContent = quiz.questions.length;
}

/* add question */
addQuestionBtn.addEventListener('click', ()=>{
  quiz.questions.push(createEmptyQuestion());
  renderEditor();
});

/* clear quiz */
document.getElementById('clearQuiz').addEventListener('click', ()=>{
  if (!confirm('Clear entire quiz?')) return;
  quiz.questions = [];
  renderEditor();
});

/* remove reference */
useRefClear.addEventListener('click', ()=>{
  refImage.src = '';
  croppedDataURL = null;
  croppedPreviewWrap.classList.add('hidden');
});

/* clear image button */
clearImageBtn.addEventListener('click', ()=>{
  cropImage.src = '';
  refImage.src = '';
  croppedDataURL = null;
  croppedPreviewWrap.classList.add('hidden');
  imagePanel.classList.add('hidden');
  fileInput.value = '';
});

/* ======= Attempt Mode ======= */
attemptModeBtn.addEventListener('click', ()=>{
  if (!quiz.questions.length) return alert('Koi question nahi hai. Add karo pehle.');
  editorPanel.classList.add('hidden');
  attemptPanel.classList.remove('hidden');
  renderAttempt();
});

backToEdit.addEventListener('click', ()=>{
  attemptPanel.classList.add('hidden');
  editorPanel.classList.remove('hidden');
  resultBox.classList.add('hidden');
});

/* render attempt questions */
function renderAttempt(){
  attemptQuestions.innerHTML = '';
  marksSummary.textContent = marksPerQ.value;
  negSummary.textContent = negPerQ.value;
  attemptCount.textContent = quiz.questions.length;
  quiz.questions.forEach((q, idx) => {
    const card = document.createElement('div');
    card.className = 'question-card';
    card.innerHTML = `<div style="font-weight:700">Q${idx+1}. ${escapeHtml(q.text)}</div><div style="margin-top:8px" class="opts-area"></div>`;
    attemptQuestions.appendChild(card);
    const optsArea = card.querySelector('.opts-area');
    q.options.forEach(opt=>{
      const lab = document.createElement('label');
      lab.className = 'opt-row';
      lab.style.marginTop = '6px';
      lab.innerHTML = `<input type="radio" name="ans_${idx}" value="${opt.label}"> <div style="margin-left:8px">${escapeHtml(opt.label)}. ${escapeHtml(opt.text)}</div>`;
      optsArea.appendChild(lab);
    });
  });
}

/* submit attempt & scoring */
submitAttempt.addEventListener('click', ()=>{
  let score = 0, correct=0, wrong=0, unattempted=0;
  const globalMarks = parseFloat(marksPerQ.value) || 0;
  const globalNeg = parseFloat(negPerQ.value) || 0;

  quiz.questions.forEach((q, idx)=>{
    const sel = document.querySelector(`input[name="ans_${idx}"]:checked`);
    if (!sel) { unattempted++; return; }
    const chosen = sel.value;
    const marks = (q.marks != null) ? q.marks : globalMarks;
    const neg = (q.negative != null) ? q.negative : globalNeg;
    if (q.correct && chosen === q.correct) {
      correct++;
      score += marks;
    } else {
      wrong++;
      score -= neg;
    }
  });

  resultBox.classList.remove('hidden');
  resultBox.innerHTML = `<div style="font-weight:800">Result</div>
    <div style="margin-top:8px">Score: <strong>${score}</strong></div>
    <div class="small muted" style="margin-top:6px">Correct: ${correct} | Wrong: ${wrong} | Unattempted: ${unattempted} | Total: ${quiz.questions.length}</div>`;
  // scroll to result
  resultBox.scrollIntoView({behavior:'smooth'});
});

/* ======= Export / Import / Save ======= */
exportJSON.addEventListener('click', ()=>{
  const out = { meta:{ marksPerQ:marksPerQ.value, negPerQ:negPerQ.value, exportedAt:new Date().toISOString() }, quiz };
  const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'manual_quiz.json'; a.click();
  URL.revokeObjectURL(url);
});

importJSON.addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text();
    try {
      const obj = JSON.parse(txt);
      if (obj.quiz) {
        quiz = obj.quiz;
        if (obj.meta) { marksPerQ.value = obj.meta.marksPerQ || marksPerQ.value; negPerQ.value = obj.meta.negPerQ || negPerQ.value; }
      } else if (obj.questions) { quiz = obj; } // fallback
      renderEditor();
      alert('Quiz imported.');
    } catch(err){ alert('Import failed: ' + err.message); }
  };
  inp.click();
});

/* Save / Load localStorage */
saveLocal.addEventListener('click', ()=>{
  const payload = { quiz, meta:{ marksPerQ:marksPerQ.value, negPerQ:negPerQ.value, savedAt:new Date().toISOString() } };
  localStorage.setItem('manual_quiz_v1', JSON.stringify(payload));
  alert('Saved locally.');
});
loadLocal.addEventListener('click', ()=>{
  const raw = localStorage.getItem('manual_quiz_v1');
  if (!raw) return alert('No saved quiz found.');
  try {
    const obj = JSON.parse(raw);
    quiz = obj.quiz || quiz;
    if (obj.meta) {
      marksPerQ.value = obj.meta.marksPerQ || marksPerQ.value;
      negPerQ.value = obj.meta.negPerQ || negPerQ.value;
    }
    renderEditor();
    alert('Loaded from local.');
  } catch(e){ alert('Load failed.'); }
});

/* Export PDF: build a printable sheet of questions */
exportPDF.addEventListener('click', ()=>{
  if (!quiz.questions.length) return alert('No questions to export.');
  const el = document.createElement('div');
  el.style.padding='20px';
  el.style.fontFamily='Arial, sans-serif';
  const title = document.createElement('h2'); title.textContent = quiz.title; el.appendChild(title);
  quiz.questions.forEach((q, i)=>{
    const qdiv = document.createElement('div');
    qdiv.style.marginBottom='12px';
    const qh = document.createElement('div'); qh.style.fontWeight='700'; qh.textContent = `${i+1}. ${q.text}`;
    qdiv.appendChild(qh);
    q.options.forEach(opt=>{
      const od = document.createElement('div'); od.textContent = `${opt.label}. ${opt.text}`; od.style.marginLeft='12px';
      qdiv.appendChild(od);
    });
    el.appendChild(qdiv);
  });
  // use html2pdf
  const opt = { margin:0.5, filename: 'manual_quiz.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:1}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'} };
  html2pdf().set(opt).from(el).save();
});

/* Utility escape */
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* initial editor render */
renderEditor();

/* Helpful: auto add sample question if none */
if (!quiz.questions.length) {
  quiz.questions.push(createSampleQuestion());
  renderEditor();
}

function createSampleQuestion(){
  return {
    id: 'q_sample',
    text: 'Sample: Which gas do plants absorb during photosynthesis?',
    options: [
      { id:'o1', label:'A', text:'Oxygen' },
      { id:'o2', label:'B', text:'Carbon Dioxide' },
      { id:'o3', label:'C', text:'Nitrogen' },
      { id:'o4', label:'D', text:'Hydrogen' }
    ],
    correct: 'B',
    marks: null,
    negative: null
  };
}

</script>
</body>
</html>
